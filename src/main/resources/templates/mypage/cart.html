<!-- templates/mypage/cart.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ì¥ë°”êµ¬ë‹ˆ ê²°ì œ</title>
  <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
</head>
<body>
<h2>ğŸ›’ ì„ íƒí•œ êµ¬ê°„ ê²°ì œ</h2>

<table>
  <thead>
  <tr><th>í•­ëª©</th><th>ìš”ê¸ˆ</th><th>ë…¸ì„  ID</th></tr>
  </thead>
  <tbody>
  <tr th:each="item : ${cart.items}">
    <td th:text="${item.name}"></td>
    <td th:text="${item.amount} + 'ì›'"></td>
    <td th:text="${item.routeId}"></td>
  </tr>
  </tbody>
</table>

<p><strong>ì´ ê²°ì œê¸ˆì•¡:</strong> <span th:text="${cart.totalAmount} + 'ì›'"></span></p>
<button onclick="requestPayment()">ê²°ì œí•˜ê¸°</button>

<script th:inline="javascript">
  const CUSTOMER_EMAIL = /*[[${email}]]*/ "guest@example.com";
  const CUSTOMER_NAME = /*[[${user.name}]]*/ "í™ê¸¸ë™"; // í•„ìš”ì‹œ
  const fareItems = /*[[${cart.items}]]*/ [];
  const totalAmount = /*[[${cart.totalAmount}]]*/ 0;
  const orderName = fareItems.map(f => f.name).join(", ");

  async function requestPayment() {
    const portone = window.PortOne;
    const merchantUid = "order_" + new Date().getTime();

    try {
      const result = await portone.requestPayment({
        storeId: "store-xxxxxx",
        paymentId: merchantUid,
        payment: {
          amount: totalAmount,
          orderName: orderName,
          currency: "KRW"
        },
        payMethod: {
          type: "CARD"
        },
        customer: {
          customerId: CUSTOMER_EMAIL, // âœ… emailì´ IDë¡œ ì‚¬ìš©ë¨
          fullName: CUSTOMER_NAME,
          phoneNumber: "01012345678",
          email: CUSTOMER_EMAIL
        }
      });

      if (result.status === "PAID") {
        const confirmResponse = await fetch("/api/payment/confirm", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            impUid: result.paymentId,
            merchantUid: merchantUid,
            email: CUSTOMER_EMAIL, // âœ… ì—¬ê¸°ì„œë„ emailë¡œ
            orderName: orderName,
            fareItems: fareItems,
            totalAmount: totalAmount
          })
        });
        const message = await confirmResponse.text();
        alert(message);
      } else {
        alert("âŒ ê²°ì œê°€ ì‹¤íŒ¨í–ˆê±°ë‚˜ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }
    } catch (e) {
      alert("âŒ ê²°ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message);
    }
  }
</script>
</body>
</html>
