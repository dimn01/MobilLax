<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ëŒ€ì¤‘êµí†µ ê²½ë¡œ ì•ˆë‚´</title>
  <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
  <script th:inline="javascript">
    const CUSTOMER_ID = /*[[${customerId}]]*/ "guest";
    const CUSTOMER_NAME = /*[[${customerName}]]*/ "ì´ë¦„ì—†ìŒ";
    const CUSTOMER_EMAIL = /*[[${customerEmail}]]*/ "noemail@example.com";
  </script>
</head>
<body>
<h1>ğŸ§­ ìƒì„¸ ê²½ë¡œ ì•ˆë‚´</h1>

<!-- âœ… ìƒì„¸ ê²½ë¡œ ë°˜ë³µ -->
<div th:each="detail, detailStat : ${details}">
  <h2>ğŸ”» ê²½ë¡œ [[${detailStat.index} + 1]]</h2>

  <div th:each="leg : ${detail.legs}">
    <h3>
      [[${leg.role}]]
      <span th:switch="${leg.mode}">
        <span th:case="'WALK'">ğŸš¶</span>
        <span th:case="'TRAIN'">ğŸš†</span>
        <span th:case="'EXPRESSBUS'">ğŸšŒ</span>
        <span th:case="'SUBWAY'">ğŸš‡</span>
        <span th:case="'BUS'">ğŸšŒ</span>
        <span th:case="*">ğŸ”</span>
      </span>
    </h3>

    <ul>
      <li>ì¶œë°œì§€: [[${leg.start.name}]]</li>
      <li>ë„ì°©ì§€: [[${leg.end.name}]]</li>
      <li>ì†Œìš” ì‹œê°„: [[${leg.formattedTime}]]</li>
      <li>ê±°ë¦¬: [[${leg.formattedDistance}]]</li>
      <li th:if="${leg.route != null}">ë…¸ì„ ëª…: [[${leg.route}]]</li>
      <li th:if="${leg.routeColor != null}">ë…¸ì„  ìƒ‰ìƒ: [[${leg.routeColor}]]</li>

      <!-- âœ… êµ¬ê°„ ìš”ê¸ˆ ë° ì¥ë°”êµ¬ë‹ˆ ë²„íŠ¼ -->
      <li th:if="${leg.routePayment != null}">
        ğŸ’¸ êµ¬ê°„ ìš”ê¸ˆ: [[${leg.routePayment}]]ì›
        <button type="button"
                th:attr="onclick=|addToCart('${leg.route}', [[${leg.routePayment}]], '${detailStat.index}')|">
          ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸°
        </button>
      </li>
    </ul>

    <!-- âœ… ë„ë³´ ì•ˆë‚´ -->
    <div th:if="${!#lists.isEmpty(leg.steps)}">
      <h4>ğŸ“ ë„ë³´ ì•ˆë‚´</h4>
      <ul>
        <li th:each="step : ${leg.steps}" th:text="${step.description}"></li>
      </ul>
    </div>

    <!-- âœ… ì •ë¥˜ì¥ ëª©ë¡ -->
    <div th:if="${!#lists.isEmpty(leg.stations)}">
      <h4>ğŸ…¿ï¸ ê²½ìœ  ì •ë¥˜ì¥</h4>
      <ul>
        <li th:each="station : ${leg.stations}">
          [[${station.stationName}]] ([[${station.lon}]], [[${station.lat}]])
        </li>
      </ul>
    </div>

    <!-- âœ… ê°€ëŠ¥í•œ ë…¸ì„  -->
    <div th:if="${!#lists.isEmpty(leg.lanes)}">
      <h4>ğŸš† ê°€ëŠ¥í•œ ë…¸ì„ </h4>
      <ul>
        <li th:each="lane : ${leg.lanes}">
          [[${lane.route}]] (ID: [[${lane.routeId}]])
        </li>
      </ul>
    </div>

    <hr>
  </div>
</div>

<!-- âœ… ê²°ì œ ë²„íŠ¼ -->
<button onclick="requestPayment()">ğŸ§¾ ì„ íƒí•œ êµ¬ê°„ ê²°ì œí•˜ê¸°</button>

<!-- âœ… ì¥ë°”êµ¬ë‹ˆ ë° ê²°ì œ ì²˜ë¦¬ -->
<script>
  let cart = [];

  function addToCart(name, amount, routeId) {
    const itemId = `${routeId}-${name}`;
    if (cart.some(item => item.id === itemId)) {
      alert("ì´ë¯¸ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸´ êµ¬ê°„ì…ë‹ˆë‹¤.");
      return;
    }
    cart.push({
      name: name,
      amount: parseInt(amount),
      routeId: `route${routeId}`,
      id: itemId
    });
    alert(`ğŸ›’ ${name} êµ¬ê°„ì´ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê²¼ìŠµë‹ˆë‹¤.`);
  }

  async function requestPayment() {
    if (cart.length === 0) {
      alert("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
      return;
    }

    const totalAmount = cart.reduce((sum, item) => sum + item.amount, 0);
    const portone = window.PortOne; // SDK v2 ì „ì—­ ê°ì²´
    const merchantUid = "order_" + new Date().getTime();

    try {
      const result = await portone.requestPayment({
        storeId: "store-xxxxxx",
        paymentId: merchantUid,
        payment: {
          amount: totalAmount,
          orderName: "ëŒ€ì¤‘êµí†µ ê²½ë¡œ ìš”ê¸ˆ",
          currency: "KRW",
        },
        payMethod: {
          type: "CARD",
        },
        customer: {
          customerId: CUSTOMER_ID,
          fullName: CUSTOMER_NAME,
          phoneNumber: "01012345678", // ë³„ë„ë¡œ ì‚¬ìš©ì ì •ë³´ê°€ ìˆë‹¤ë©´ ë™ì ìœ¼ë¡œ ì„¤ì •
          email: CUSTOMER_EMAIL,
        },
      });

      if (result.status === "PAID") {
        const confirmResponse = await fetch("/api/payment/confirm", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            impUid: result.paymentId,
            merchantUid: merchantUid,
            userId: "user123",
            fareItems: cart,
            totalAmount: totalAmount
          })
        });

        const message = await confirmResponse.text();
        alert(message);
        cart = [];
      } else {
        alert("âŒ ê²°ì œ ì‹¤íŒ¨ ë˜ëŠ” ë¯¸ì™„ë£Œ ìƒíƒœì…ë‹ˆë‹¤.");
      }
    } catch (e) {
      alert("âŒ ê²°ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message);
    }
  }
</script>

</body>
</html>
